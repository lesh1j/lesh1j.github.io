<!DOCTYPE html>
<html>
<head>
    <title>Карта</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <script src="//api-maps.yandex.ru/2.1/?lang=ru-RU" type="text/javascript"></script>
    <script src="//yandex.st/jquery/2.2.3/jquery.min.js" type="text/javascript"></script>
	<style>
        html, body, #map {
            width: 100%; height: 100%; padding: 0; margin: 0;
        }
    </style>
</head>
<body>
<div id="map"></div>
<script>
    
    // создаем объект с описание меток на карте
    
    var data = {
    "type": "FeatureCollection",
    "features": [
        {"type": "Feature", "id": 0, "geometry": {"type": "Point", "coordinates": [54.1876279, 37.5310531]}, "properties": {"balloonContentHeader": 'ООО "Демидовская вода"', "balloonContentBody": "г. Тула, Одоевское шоссе, 81<br>Время работы: с 8 до 20 час.", "hintContent": "г. Тула, Одоевское шоссе, 81"}},
        {"type": "Feature", "id": 1, "geometry": {"type": "Point", "coordinates": [54.208398, 37.575703]}, "properties": {"balloonContentHeader": 'АЗС № 72 (ОАО «Туланефтепродукт»)', "balloonContentBody": "г. Тула, ул. Нижняя Упская, д.15<br>круглосуточно", "hintContent": "г. Тула, ул. Нижняя Упская, д.15"}},
        {"type": "Feature", "id": 2, "geometry": {"type": "Point", "coordinates": [54.132982, 37.573429]}, "properties": {"balloonContentHeader": 'м-н "Продукты" (ИП Новикова Н.А.)', "balloonContentBody": "Ленинский р-н, п. Барсуки, ул. Шоссейная, д.4<br>с 8 до 21 час.", "hintContent": "Ленинский р-н, п. Барсуки, ул. Шоссейная, д.4"}},
        {"type": "Feature", "id": 3, "geometry": {"type": "Point", "coordinates": [54.095212, 37.6143069]}, "properties": {"balloonContentHeader": 'м-н "Виктория" (ИП Толкачева Е.С.)', "balloonContentBody": "Ленинский р-н, п. Новая Мыза, Шоссейная ул, дом № 7<br>с 8 до 22ч.", "hintContent": "Ленинский р-н, п. Новая Мыза, Шоссейная ул, дом № 7"}},
        {"type": "Feature", "id": 4, "geometry": {"type": "Point", "coordinates": [54.242414, 37.618029]}, "properties": {"balloonContentHeader": 'АЗС № 69 (ОАО «Туланефтепродукт»)', "balloonContentBody": "г. Тула, ул. Октябрьская, д. 301<br>круглосуточно", "hintContent": "г. Тула, ул. Октябрьская, д. 301"}},
        {"type": "Feature", "id": 5, "geometry": {"type": "Point", "coordinates": [54.265522, 37.6008017]}, "properties": {"balloonContentHeader": 'АЗС «Престиж» (ООО «Престиж»)', "balloonContentBody": "п.Горелки, Московское ш, д. 55<br>круглосуточно", "hintContent": "п.Горелки, Московское ш, д. 55"}},
        {"type": "Feature", "id": 6, "geometry": {"type": "Point", "coordinates": [54.28406663, 37.60366291]}, "properties": {"balloonContentHeader": 'Магазин "Сельхозпродукты" (ИП Александрова Н.В.)', "balloonContentBody": "п. Хомяково, Хомяковское ш., дом № 2, строение 1/11<br>с 9 до 19 час.", "hintContent": "п. Хомяково, Хомяковское ш., дом № 2, строение 1/11"}},
        {"type": "Feature", "id": 7, "geometry": {"type": "Point", "coordinates": [54.228213, 37.655479]}, "properties": {"balloonContentHeader": 'АЗС № 21 (ОАО «Туланефтепродукт»)', "balloonContentBody": "г. Тула, Веневское ш, д. 24<br>круглосуточно", "hintContent": "г. Тула, Веневское ш, д. 24"}},
        {"type": "Feature", "id": 8, "geometry": {"type": "Point", "coordinates": [54.2202866, 37.6826363]}, "properties": {"balloonContentHeader": 'ИП Рязанцева А.С.', "balloonContentBody": "г. Тула, ул. Щегловская засека, д. 25<br>с 9 до 19 час.", "hintContent": "г. Тула, ул. Щегловская засека, д. 25"}},
        {"type": "Feature", "id": 9, "geometry": {"type": "Point", "coordinates": [54.1902315, 37.6982109]}, "properties": {"balloonContentHeader": 'Магазин (ИП Бондаренко Н.Н.)', "balloonContentBody": "г. Тула, ул. Кутузова, д. 145<br>с 9 до 19 час.", "hintContent": "г. Тула, ул. Кутузова, д. 145"}},
        ]
    }
    
    // загружаем карту, когда api готово
    ymaps.ready(init);

    function init () {
        // инициализируем карту и объявляем изначальные центр и масштаб
        var myMap = new ymaps.Map('map', {
            center: [54.204836, 37.6184915],
            zoom: 10
        }, {
            searchControlProvider: 'yandex#search'
        }),
        objectManager = new ymaps.ObjectManager({
            // Чтобы метки начали кластеризоваться, выставляем опцию.
            clusterize: true,
            // ObjectManager принимает те же опции, что и кластеризатор.
            gridSize: 32,
            clusterDisableClickZoom: false
        });

        // Чтобы задать опции одиночным объектам и кластерам,
        // обратимся к дочерним коллекциям ObjectManager.
        objectManager.objects.options.set('preset', 'islands#blueCircleDotIcon');
        objectManager.clusters.options.set('preset', 'islands#blueClusterIcons');
        objectManager.objects.options.set('hideIconOnBalloonOpen', false);
        
        // добавляем маркеры на карту
        myMap.geoObjects.add(objectManager);
        objectManager.add(data);
        
        var userLocation = [];
        
        // определяем местоположение пользователя
        ymaps.geolocation.get({
            // Выставляем опцию для определения положения по auto
            // Geolocation.API если доступен, если нет - то по ip
            provider: 'auto',
        }).then(function (result) {
            
            userLocation = result.geoObjects.position;
            // добавляем значок с местоположением пользователя
            myMap.geoObjects.add(result.geoObjects);
                    
            var features = data.features;
            var pointLocation, distanceToPoint, nearPointLocation, nearPointId;
            var minDistance = Infinity;
            
            // перебираем метки и находи ближайшую к пользователю
            for (var key in features) {
                
                // координаты метки
                pointLocation = features[key].geometry.coordinates;
                
                // определяем расстояние от пользователя до метки
                distanceToPoint = ymaps.coordSystem.geo.getDistance(userLocation, pointLocation);
                
                // выбираем минимальное расстояние
                if(distanceToPoint < minDistance){
                    minDistance = distanceToPoint;
                    nearPointLocation = pointLocation;
                    nearPointId = features[key].id;
                }
                
            }
            
            // задаем центр карты по ближайшей метке и увеличиваем масштаб до 14
            myMap.setCenter(nearPointLocation, 14);
            
            // открываем балун ближайше метки
            var objectState = objectManager.getObjectState(nearPointId);
            if (objectState.isClustered) {
                // Сделаем так, чтобы указанный объект был "выбран" в балуне.
                objectManager.clusters.state.set('activeObject', objectManager.objects.getById(nearPointId));
                objectManager.clusters.balloon.open(objectState.cluster.id);
            } else {
                objectManager.objects.balloon.open(nearPointId);
            }
            
        });
        
    }
</script>
</body>
</html>
